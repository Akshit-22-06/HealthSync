{% extends "base.html" %}
{% block content %}

<style>
.dashboard-wrapper {
    padding: 40px 8%;
}

.hero {
    background: linear-gradient(135deg, #2c3e50, #3f8f7a);
    color: white;
    padding: 40px;
    border-radius: 16px;
    margin-bottom: 40px;
}

.hero h2 {
    margin: 0;
    font-size: 28px;
}

.hero .score {
    font-size: 52px;
    font-weight: bold;
    margin-top: 10px;
}

.card {
    background: white;
    padding: 25px;
    border-radius: 14px;
    margin-bottom: 30px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-box {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-box h4 {
    margin: 0;
    color: #666;
}

.stat-box p {
    font-size: 22px;
    font-weight: bold;
    margin-top: 8px;
}

.chart-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

form input, form select {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

button {
    background: #3f8f7a;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
}

button:hover {
    opacity: 0.9;
}

.logs-table {
    width: 100%;
    border-collapse: collapse;
}

.logs-table th, .logs-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    text-align: center;
}

.tip-box {
    background: #fdeeee;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
}
</style>


<div class="dashboard-wrapper">

    <!-- HERO -->
    <div class="hero">
        <h2>Welcome, {{ request.user.username }}</h2>
        <div class="score">{{ avg_score }} / 10</div>
        <p>Your Average Health Score</p>
    </div>

    <!-- INPUT FORM -->
    <div class="card">
        <h3>Log Today's Health</h3>
        <form method="POST">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Save Log</button>
        </form>
    </div>


    <!-- TIPS -->
    <div class="card">
        <h3>Personalized Tips</h3>
        {% for tip in tips %}
            <div class="tip-box">{{ tip }}</div>
        {% endfor %}
    </div>

    <!-- AVERAGE STATS -->
    <div class="stats-grid">
        <div class="stat-box">
            <h4>Avg Sleep</h4>
            <p>{{ avg_sleep }} hrs</p>
        </div>

        <div class="stat-box">
            <h4>Avg Water</h4>
            <p>{{ avg_water }} L</p>
        </div>

        <div class="stat-box">
            <h4>Avg Mood</h4>
            <p>{{ avg_mood }} / 5</p>
        </div>

        <div class="stat-box">
            <h4>Avg Exercise</h4>
            <p>{{ avg_exercise }} min</p>
        </div>
    </div>


    {% if has_logs %}

    <!-- SMALL CHARTS -->
    <div class="chart-row">
        <div class="card">
            <h3>Sleep Trend</h3>
            <canvas id="sleepChart"></canvas>
        </div>

        <div class="card">
            <h3>Mood & Exercise</h3>
            <canvas id="moodExerciseChart"></canvas>
        </div>
    </div>

    {% else %}
    <div class="card">
        <h3>No Health Logs Yet</h3>
        <p>Add your first log to see charts and progress.</p>
    </div>
    {% endif %}


    <!-- MAIN MONTHLY CHART -->
    <div class="card">
        <h3>Monthly Health Score Trend</h3>
        <canvas id="scoreChart"></canvas>
    </div>

    
    <!-- RECENT LOGS -->
    <div class="card">
        <h3>Recent Health Logs</h3>

        {% if logs %}
        <table class="logs-table">
            <tr>
                <th>Date</th>
                <th>Sleep</th>
                <th>Water</th>
                <th>Mood</th>
                <th>Exercise</th>
                <th>Score</th>
                <th>Action</th>
            </tr>

            {% for log in logs %}
            <tr>
                <td>{{ log.date }}</td>
                <td>{{ log.sleep_hours }}</td>
                <td>{{ log.water_liters }}</td>
                <td>{{ log.mood }}</td>
                <td>{{ log.exercise_minutes }}</td>
                <td><strong>{{ log.total_score }} / 10</strong></td>
                <td>
                    <a href="{% url 'edit_log' log.pk %}">Edit</a> |
                    <a href="{% url 'delete_log' log.pk %}">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
            <p>No logs yet.</p>
        {% endif %}
    </div>

</div>


<!-- CHART JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const hasLogs = {{ has_logs|yesno:"true,false" }};

if (hasLogs) {

new Chart(document.getElementById("scoreChart"), {
    type: 'line',
    data: {
        labels: {{ monthly_labels|safe }},
        datasets: [{
            label: 'Monthly Avg Score',
            data: {{ monthly_scores|safe }},
            borderColor: '#2c3e50',
            tension: 0.4
        }]
    }
});

new Chart(document.getElementById("sleepChart"), {
    type: 'line',
    data: {
        labels: {{ daily_labels|safe }},
        datasets: [{
            label: 'Sleep',
            data: {{ sleep_data|safe }},
            borderColor: '#3f8f7a',
            tension: 0.4
        }]
    }
});

new Chart(document.getElementById("moodExerciseChart"), {
    type: 'line',
    data: {
        labels: {{ daily_labels|safe }},
        datasets: [
            {
                label: 'Mood',
                data: {{ mood_data|safe }},
                borderColor: '#e67e22',
                tension: 0.4
            },
            {
                label: 'Exercise',
                data: {{ exercise_data|safe }},
                borderColor: '#c0392b',
                tension: 0.4
            }
        ]
    }
});

}
</script>

{% endblock %}